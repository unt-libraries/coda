name: Test coda

on: [push, pull_request, workflow_dispatch]

jobs:
  # Label of the container job
  container-job:
    runs-on: ubuntu-20.04
    # Docker Hub image that `container-job` executes in
    container: python:3.7-stretch

    services:
      mysql:
        image: mariadb:10.3
        ports: 
          - 3306
        env:
          MYSQL_USER: coda_user
          MYSQL_PASSWORD: coda_pass
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: coda_local
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=10s --health-retries=10

    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          pip install -r requirements.txt
          cp secrets.json.template secrets.json
      - name: Lint with flake8
        run: |
          # Python syntax errors or undefined names will stop the build completely.
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero will still allow the tests to pass, with these types of errors as warnings.
          # flake8 coda --count --exit-zero --max-line-length=99 --statistics
      - name: Set pythonpath
        run: |
          echo "PYTHONPATH=$PWD/coda"
      - name: Run the tests
        env:
          DB_CONNECTION: mysql
          DB_PORT: 3306
          DB_USER: coda_user
          DB_PASSWORD: coda_pass
          DB_DATABASE: coda_local
        run: |
            pytest